<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">LP</span>, <span class="var type1" id="S3T2U4">iter_change</span>] = laplace_iters(<span class="var type1" id="S4T3U7">fg</span>,<span class="var type1" id="S5T3U8">source</span>,<span class="var type1" id="S6T3U9">sink</span>,<span class="var type1" id="S7T4U10">init</span>,<span class="var type1" id="S8T5U11">maxiters</span>,<span class="var type1" id="S9T6U12">sz</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="mxinfo " id="T5:U9"><span class="var type1" id="S10T5U15">change_threshold</span> = <span class="mxinfo " id="T5:U11"><span class="mxinfo " id="T5:U12">10</span>^(-3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%filter set-up (26 nearest neighbours)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo " id="T7:U13"><span class="var type1" id="S11T7U23">hl</span>=<span class="mxinfo " id="T7:U15">ones(<span class="mxinfo " id="T5:U16">3</span>,<span class="mxinfo " id="T5:U17">3</span>,<span class="mxinfo " id="T5:U18">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo " id="T7:U19"><span class="var type1" id="S11T7U31">hl</span> = <span class="mxinfo " id="T7:U21"><span class="var type1" id="S11T7U33">hl</span>/26</span></span>; <span class="mxinfo " id="T5:U23"><span class="mxinfo " id="T5:U24"><span class="var type1" id="S11T7U38">hl</span>(<span class="mxinfo " id="T8:U26">2</span>,<span class="mxinfo " id="T8:U27">2</span>,<span class="mxinfo " id="T8:U28">2</span>)</span> = <span class="mxinfo " id="T5:U29">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% filter set-up (6 NN) (safer, especially in cases of coronal non-oblique</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% where dark band is more likely to 'leak' across diagonals</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">% hl = strel('sphere',1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="comment">% hl = double(hl.Neighborhood);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="mxinfo " id="T2:U30"><span class="var type1" id="S13T2U45">elems</span> = <span class="mxinfo " id="T2:U32">1: <span class="mxinfo " id="T5:U33"><span class="mxinfo " id="T5:U34"><span class="mxinfo " id="T5:U35"><span class="var type1" id="S9T6U51">sz</span>(<span class="mxinfo " id="T8:U37">1</span>)</span>*<span class="mxinfo " id="T5:U38"><span class="var type1" id="S9T6U54">sz</span>(<span class="mxinfo " id="T5:U40">2</span>)</span></span>*<span class="mxinfo " id="T5:U41"><span class="var type1" id="S9T6U57">sz</span>(<span class="mxinfo " id="T5:U43">3</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"><span class="comment">%set up all requisite variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo " id="T1:U44"><span class="var type1" id="S14T1U61">vel</span> = <span class="mxinfo " id="T1:U46">nan(<span class="var type1" id="S9T6U64">sz</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo " id="T3:U48"><span class="mxinfo " id="T3:U49"><span class="var type1" id="S14T1U68">vel</span>(<span class="var type1" id="S4T3U69">fg</span>)</span>=<span class="var type1" id="S7T4U70">init</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo " id="T3:U53"><span class="mxinfo " id="T3:U54"><span class="var type1" id="S14T1U74">vel</span>(<span class="var type1" id="S5T3U75">source</span>)</span>=<span class="mxinfo " id="T5:U57">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo " id="T3:U58"><span class="mxinfo " id="T3:U59"><span class="var type1" id="S14T1U80">vel</span>(<span class="var type1" id="S6T3U81">sink</span>)</span>=<span class="mxinfo " id="T5:U62">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo " id="T3:U63"><span class="var type1" id="S16T3U85">bg</span> = <span class="mxinfo " id="T3:U65">(<span class="mxinfo " id="T2:U66">setdiff(<span class="var type1" id="S13T2U90">elems</span>,<span class="mxinfo " id="T3:U68">sort(<span class="mxinfo " id="T3:U69">[<span class="var type1" id="S4T3U95">fg</span>;<span class="var type1" id="S5T3U97">source</span>;<span class="var type1" id="S6T3U99">sink</span>]</span>)</span>)</span>)'</span></span>; <span class="comment">% bg in indices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo " id="T3:U73"><span class="mxinfo " id="T3:U74"><span class="var type1" id="S14T1U103">vel</span>(<span class="var type1" id="S16T3U104">bg</span>)</span>=<span class="mxinfo " id="T5:U77">0</span></span>; <span class="comment">%must be insulated after filtering</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo " id="T2:U78"><span class="var type1" id="S3T2U108">iter_change</span> = <span class="mxinfo " id="T2:U80">zeros(<span class="mxinfo " id="T5:U81">1</span>,<span class="var type1" id="S8T5U112">maxiters</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo " id="T1:U83"><span class="var type1" id="S20T1U115">insulate_correction</span> = <span class="mxinfo " id="T1:U85">zeros(<span class="var type1" id="S9T6U118">sz</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"><span class="mxinfo " id="T3:U87"><span class="mxinfo " id="T3:U88"><span class="var type1" id="S20T1U122">insulate_correction</span>(<span class="mxinfo " id="T3:U90">[<span class="var type1" id="S4T3U125">fg</span>;<span class="var type1" id="S5T3U127">source</span>;<span class="var type1" id="S6T3U129">sink</span>]</span>)</span> = <span class="mxinfo " id="T5:U94">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"><span class="mxinfo " id="T1:U95"><span class="var type1" id="S20T1U133">insulate_correction</span> = <span class="mxinfo " id="T1:U97">imfilter(<span class="var type1" id="S20T1U136">insulate_correction</span>,<span class="var type1" id="S11T7U137">hl</span>,<span class="string">'replicate'</span>,<span class="string">'conv'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line"><span class="comment">% apply filter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line"><span class="mxinfo " id="T5:U100"><span class="var type1" id="S22T5U142">iters</span> = <span class="mxinfo " id="T5:U102">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo " id="T9:U103"><span class="var type1" id="S22T5U146">iters</span> &lt; <span class="var type1" id="S8T5U147">maxiters</span></span> <span class="comment">%max iterations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">    <span class="mxinfo " id="T5:U106"><span class="var type1" id="S22T5U150">iters</span> = <span class="mxinfo " id="T5:U108"><span class="var type1" id="S22T5U152">iters</span>+<span class="mxinfo " id="T5:U110">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">    <span class="mxinfo " id="T1:U111"><span class="var type1" id="S23T1U156">velup</span> = <span class="mxinfo " id="T1:U113">imfilter(<span class="var type1" id="S14T1U159">vel</span>,<span class="var type1" id="S11T7U160">hl</span>,<span class="string">'replicate'</span>,<span class="string">'conv'</span>)</span></span>; <span class="comment">%apply averaging filter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">    <span class="comment">%insulate the grey matter so gradient doesn't pass between folds -</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">    <span class="comment">%inspired by ndnanfilter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">    <span class="mxinfo " id="T1:U116"><span class="var type1" id="S23T1U165">velup</span> = <span class="mxinfo " id="T1:U118"><span class="var type1" id="S23T1U167">velup</span>./<span class="var type1" id="S20T1U168">insulate_correction</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">    <span class="mxinfo " id="T3:U121"><span class="mxinfo " id="T3:U122"><span class="var type1" id="S23T1U172">velup</span>(<span class="var type1" id="S16T3U173">bg</span>)</span> = <span class="mxinfo " id="T5:U125">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="mxinfo " id="T3:U126"><span class="mxinfo " id="T3:U127"><span class="var type1" id="S23T1U178">velup</span>(<span class="var type1" id="S5T3U179">source</span>)</span> = <span class="mxinfo " id="T5:U130">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">    <span class="mxinfo " id="T3:U131"><span class="mxinfo " id="T3:U132"><span class="var type1" id="S23T1U184">velup</span>(<span class="var type1" id="S6T3U185">sink</span>)</span> = <span class="mxinfo " id="T5:U135">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">    <span class="comment">%stopping condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">    <span class="mxinfo " id="T5:U136"><span class="mxinfo " id="T5:U137"><span class="var type1" id="S3T2U190">iter_change</span>(<span class="var type1" id="S22T5U191">iters</span>)</span> = <span class="mxinfo " id="T5:U140">nansum(<span class="mxinfo " id="T3:U141">abs(<span class="mxinfo " id="T3:U142"><span class="mxinfo " id="T3:U143"><span class="var type1" id="S14T1U198">vel</span>(<span class="var type1" id="S4T3U199">fg</span>)</span>-<span class="mxinfo " id="T3:U146"><span class="var type1" id="S23T1U201">velup</span>(<span class="var type1" id="S4T3U202">fg</span>)</span></span>)</span>)</span></span>; <span class="comment">%compute change from last iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">    <span class="mxinfo " id="T1:U149"><span class="var type1" id="S14T1U205">vel</span> = <span class="var type1" id="S23T1U206">velup</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T9:U152"><span class="mxinfo " id="T5:U153"><span class="var type1" id="S3T2U211">iter_change</span>(<span class="var type1" id="S22T5U212">iters</span>)</span>&lt;<span class="var type1" id="S10T5U213">change_threshold</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line">        <span class="keyword">break</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line"><span class="mxinfo " id="T1:U157"><span class="var type1" id="S14T1U217">vel</span> = <span class="mxinfo " id="T1:U159"><span class="var type1" id="S14T1U219">vel</span>./<span class="mxinfo " id="T5:U161">max(<span class="mxinfo " id="T3:U162"><span class="var type1" id="S14T1U223">vel</span>(:)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50">50</a></span><span class="line"><span class="mxinfo " id="T3:U164"><span class="mxinfo " id="T3:U165"><span class="var type1" id="S14T1U228">vel</span>(<span class="mxinfo " id="T10:U167">~<span class="var type1" id="S4T3U230">fg</span></span>)</span> = <span class="mxinfo " id="T5:U169">nan</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51">51</a></span><span class="line"><span class="mxinfo " id="T1:U170"><span class="var type1" id="S2T1U235">LP</span> = <span class="var type1" id="S14T1U236">vel</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52">52</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</body>
</html>
